<!doctype html>
<html>
<head>
  <title>MDHT BEP44 client</title>
  <script>
  function setText (id, text) { document.getElementById(id).textContent = text }
  function setVal (id, val) { document.getElementById(id).value = val }
  function getVal (id) { return document.getElementById(id).value.trim() }
  function getChecked (id) { return document.getElementById(id).checked }
  function report (obj) { return Object.entries(obj).map(([k, v]) => { return k + ': ' + v }).join(', ') }
  function hexToString(hex) {
    let str = ''
    for (let i = 0; i < hex.length; i += 2) { str += String.fromCharCode(parseInt(hex.slice(i, i + 2), 16)) }
    return str
  }
  function checkHex(hex) {
    if (/[^0-9a-fA-F]/.test(hex) || hex.length != 40) { alert('Enter 40 hex'); return '' }
    return hex
  }
  function hexToBuff(hex) {
    const a = []
    for (let i = 0; i < 40; i += 2) a.push(parseInt(hex.slice(i, i + 2), 16))
    return { type: 'Buffer', data: a }
  }
  function mutableSalt () {
    const mutable = getChecked('mutable')
    const salt = getVal('salt')
    if (mutable && salt !== '') return salt
    return mutable
  }
  function walk (obj) { // recursively walk through object, converting { type: 'Buffer', data: array of integers } to hex string
    for (const k in obj) {
      if (obj.hasOwnProperty(k)) {
        const v = obj[k]
        if (v && v.type === 'Buffer' && Array.isArray(v.data)) {
          obj[k] = v.data.map((i) => { let hex = i.toString(16); hex.length === 2 || (hex = '0' + hex); return hex }).join('')
        } else if (!Array.isArray(obj) && typeof obj !== 'string') walk(obj[k])
      }
    }
  }
  function query (req, done) {
    fetch('', { method: 'POST', body: JSON.stringify(req), headers: { 'Content-Type': 'application/json' } })
    .then((res) => { if (!res.ok) throw 'Network error'; res.json().then((res) => { walk(res); done(res) }) })
    .catch ((err) => { alert('Network error') })
  }
  function put () {
    const req = { method: 'putData', args: {} }
    const v = getVal('v')
    if (v === '') return
    req.args.v = v; req.args.mutableSalt = mutableSalt()
    query(req, (res) => {
      res.target && setVal('target', res.target)
      delete res.target; delete res.v; delete res.k; delete res.sig; delete res.salt
      setText('puts', report(res))
    })
  }
  function get () {
    const req = { method: 'getData', args: {} }
    const target = checkHex(getVal('target'))
    if (target === '') return
    req.args.target = hexToBuff(target); req.args.mutableSalt = mutableSalt()
    query(req, (res) => {
      res.v && setVal('v', hexToString(res.v))
      delete res.v
      setText('gets', report(res))
    })
  }
  </script>
</head>
<body>
  <p>Mutable: <input type="checkbox" id="mutable"></p>
  <p>Salt: <input type="text" id="salt" size="30"></p>
  <table>
    <tr>
      <th>Data</th><th>Target</th>
    </tr><tr>
      <td><textarea id="v" cols="40" rows="5">One for all</textarea></td>
      <td><input type="text" id="target" maxlength="40" size="40"></td>
    </tr><tr>
      <td><button onclick="put()">Put data</button></td>
      <td><button onclick="get()">Get data</button></td>
    </tr><tr>
      <td><span id = "puts"></span></td>
      <td><span id = "gets"></span></td>
    </tr>
  </table>
</body>
</html>
